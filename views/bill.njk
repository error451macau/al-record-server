{% extends "parent.njk" %}

{% block title %}{{bill.title[locale]}}{% endblock %}

{# the value is X as in X% #}
{% set voteYPercent = (voteSummary.Y / voteSummary.total * 100) | round %}
{% set voteNPercent = (voteSummary.N / voteSummary.total * 100) | round %}
{% set votePPercent = (voteSummary.P / voteSummary.total * 100) | round %}
{% set voteAPercent = (voteSummary.A / voteSummary.total * 100) | round %}

{% block body %}
    <div class="bill container clear-margin">
        <h1>{{bill.title[locale]}}{{a}}</h1>
        <section class="row bill-meta">
            {% set proposer = deputiesDict[bill.proposerDeputyId] %}
            <div class="col s4 bill-meta-proposer">
                <h4>{{__('BILL_PROPOSER')}}</h4>
                <div class="bill-meta-proposer__inner">
                    <img class="avatar avatar--30" src="{{mklink('abs', 'img/deputies/' + proposer.id + '.jpg')}}"><a href="{{mklink('deputy', proposer)}}">{{proposer.name[locale]}} ({{__('DEPUTY_METHOD_SHORT_' + proposer.electedMethod)}})</a>
                </div>
            </div>
            <div class="col s4 bill-meta-voting-date">
                <h4>{{__('BILL_VOTING_DATE')}}</h4>
                <div class="bill-meta-voting-date__inner">
                    {{bill.date | dateFormat}}
                </div>
            </div>
            <div class="col s4 bill-meta-result">
                <div class="bill-meta-result__inner bill-meta-result__inner--{{bill.result | lower}}">
                    {{__('BILL_RESULT_' + bill.result)}}
                </div>
            </div>
        </section>
        <section class="bill-synopsis">
            <h4>{{__('BILL_SYNOPSIS')}}</h4>
            <div class="content-highlight">{{bill.synopsis[locale]}}</div>
        </section>
        <section class="bill-votes-summary">
            <h4>{{__('BILL_VOTES_SUMMARY')}}</h4>
            <div class="content-highlight">
                <div class="row">
                    <div class="col s12 l4">
                        {# todo: un-hardcode color #}
                        {% set pieData = [{
                            values: [voteSummary.Y, voteSummary.N, voteSummary.P, voteSummary.A],
                            labels: [__('VOTE_Y'), __('VOTE_N'), __('VOTE_P'), __('VOTE_A')],
                            type: 'pie',
                            sort: false,
                            direction: 'clockwise',
                            marker: {
                                colors: ['#5cd693', '#ff775b', '#4a4a4a', '#e6e6e6']
                            }
                        }] %}
                        <div id="bill-votes-summary__pie" class="bill-votes-summary__pie" data-pie-data="{{pieData | dump}}"></div>
                    </div>
                    <div class="col s12 l8">
                        <table class="bordered bill-votes-summary__table">
                            <thead>
                                <tr>
                                    <th>{{__('BILL_VOTES_SUMMARY_TOTAL')}}</th>
                                    <th style="width:50%">&nbsp;</th>
                                    <th class="center-align"><span class="legend legend--circle legend--direct"   ></span><span>{{__('DEPUTY_METHOD_SHORT_direct')}}</span></th>
                                    <th class="center-align"><span class="legend legend--circle legend--indirect" ></span><span>{{__('DEPUTY_METHOD_SHORT_indirect')}}</span></th>
                                    <th class="center-align"><span class="legend legend--circle legend--appointed"></span><span>{{__('DEPUTY_METHOD_SHORT_appointed')}}</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% macro renderBillVotesSummaryRow(vote) %}
                                    {% set votesFromDirect    = voteSummary['direct' + vote] or 0    %}
                                    {% set votesFromIndirect  = voteSummary['indirect' + vote] or 0  %}
                                    {% set votesFromAppointed = voteSummary['appointed' + vote] or 0 %}
                                    <tr>
                                        <td><span class="legend legend--vote-{{vote | lower}}"></span><span>{{__('VOTE_' + vote)}}</span></td>
                                        <td>
                                            <div class="bar">
                                                <div class="bar__segment bar__segment--direct"    style="width:{{votesFromDirect    / voteSummary.relativeMax * 100}}%"></div>
                                                <div class="bar__segment bar__segment--indirect"  style="width:{{votesFromIndirect  / voteSummary.relativeMax * 100}}%"></div>
                                                <div class="bar__segment bar__segment--appointed" style="width:{{votesFromAppointed / voteSummary.relativeMax * 100}}%"></div>
                                            </div>{{''-}}
                                            <span class="percentage">{{voteSummary[vote + 'Percent']}}%</span>
                                        </td>
                                        <td class="center-align">{{votesFromDirect or 0}}</td>
                                        <td class="center-align">{{votesFromIndirect or 0}}</td>
                                        <td class="center-align">{{votesFromAppointed or 0}}</td>
                                    </tr>
                                {% endmacro %}
                                
                                {{ renderBillVotesSummaryRow('Y') }}
                                {{ renderBillVotesSummaryRow('N') }}
                                {% if(voteSummary.P > 0) %}
                                    {{ renderBillVotesSummaryRow('P') }}
                                {% endif %}
                                {% if(voteSummary.A > 0) %}
                                    {{ renderBillVotesSummaryRow('A') }}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        <section class="bill-votes-detail">
            <h4>{{__('BILL_VOTES')}}</h4>
            {% macro renderBillVoteDetailColumn(deputiesList) %}
                {% for deputy in deputiesList %}
                    <li>
                        <a href="{{mklink('deputy', deputy)}}">
                            <img class="avatar" src="{{mklink('abs', 'img/deputies/' + deputy.id + '.jpg')}}"><span>{{deputy.name[locale]}}</span>
                        </a>
                    </li>
                {% endfor %}
            {% endmacro %}
            <div class="row">
                <div class="col s12 m6 xl3">
                    <div class="content-highlight content-highlight--y {{'content-highlight--y-strong' if voteSummary.relativeMax == voteSummary.Y}}">
                        <h5>{{__('VOTE_Y')}}</h5>
                        <span class="summary">{{voteSummary.Y}} {{__('NOUN_VOTES')}} 路 {{voteYPercent}}%</span>
                        <ul>{{renderBillVoteDetailColumn(deputiesGrouped.Y)}}</ul>
                    </div>
                </div>
                <div class="col s12 m6 xl3">
                    <div class="content-highlight content-highlight--n {{'content-highlight--n-strong' if voteSummary.relativeMax == voteSummary.N}}">
                        <h5>{{__('VOTE_N')}}</h5>
                        <span class="summary">{{voteSummary.N}} {{__('NOUN_VOTES')}} 路 {{voteNPercent}}%</span>
                        <ul>{{renderBillVoteDetailColumn(deputiesGrouped.N)}}</ul>
                    </div>
                </div>
                <div class="col s12 m6 xl3">
                    <div class="content-highlight content-highlight--p">
                        <h5>{{__('VOTE_P')}}</h5>
                        <span class="summary">{{voteSummary.P}} {{__('NOUN_VOTES')}} 路 {{votePPercent}}%</span>
                        <ul>{{renderBillVoteDetailColumn(deputiesGrouped.A)}}</ul>
                    </div>
                </div>
                <div class="col s12 m6 xl3">
                    <div class="content-highlight content-highlight--a">
                        <h5>{{__('VOTE_A')}}</h5>
                        <span class="summary">{{voteSummary.A}} {{__('NOUN_VOTES')}} 路 {{voteAPercent}}%</span>
                        <ul>{{renderBillVoteDetailColumn(deputiesGrouped.P)}}</ul>
                    </div>
                </div>
            </div>
        </section>
        <section class="bill-documents">
            <h4>{{__('BILL_DOCUMENTS')}}</h4>
            {% if bill.documentIds.length > 0 %}
                <ul class="content-highlight collection">
                    {% for documentId in bill.documentIds %}
                        {% set document = documentsDict[documentId] %}
                        <li class="collection-item">
                            {% include "partials/document-desc.njk" %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="content-highlight">
                    {{__('NONE')}}
                </div>
            {% endif %}
        </section>
    </div>
{% endblock %}
